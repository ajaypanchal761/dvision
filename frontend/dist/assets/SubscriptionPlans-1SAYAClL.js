import{u as L,a as k,r as v,E as M,j as e,c as T,R as B,m as z,C as Y,G as U,H as q}from"./index-BPKQ2keO.js";const K=()=>{const E=L(),{user:t}=k(),[S,F]=v.useState([]),[A,w]=v.useState(!0),[j,p]=v.useState(""),[P,x]=v.useState(null),{getCurrentUser:H}=k(),c=t?.class,d=t?.board;v.useEffect(()=>{t&&c&&d?D():t&&(p("Please complete your profile with class and board information"),w(!1))},[t,c,d]);const D=async()=>{try{if(w(!0),p(""),!c||!d){p("Please complete your profile with class and board information"),w(!1);return}console.log("Fetching subscription plans for:",{board:d,class:c});const s=await M.getPlans(d,c);if(console.log("Subscription plans response:",s),s.success&&s.data?.subscriptionPlans){const n=s.data.subscriptionPlans;console.log("Plans fetched successfully:",n.length,"plans");const a=n.filter(o=>o.duration==="demo"?!1:o.type==="regular"?o.board===d&&o.classes&&Array.isArray(o.classes)&&o.classes.includes(parseInt(c)):o.type==="preparation");console.log("Filtered plans:",a.length,"plans match student criteria"),F(a)}else console.error("Invalid response format:",s),p("Failed to load subscription plans")}catch(s){console.error("Error fetching subscription plans:",s),p(s.message||"Failed to load subscription plans")}finally{w(!1)}},_=s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(s),C=s=>({monthly:"Monthly",quarterly:"Quarterly",half_yearly:"Half Yearly",yearly:"Yearly",demo:"Demo"})[s]||s,$=async s=>{console.log("=== SUBSCRIBE BUTTON CLICKED ==="),console.log("Plan:",s),console.log("User:",t);try{if(x(s._id),p(""),!window.Cashfree)throw console.error("Cashfree script not loaded"),new Error("Payment gateway not available. Please refresh the page.");const n=s.type||"regular";let a=!1,o="";if(n==="regular"){const r=t?.board,i=t?.class;a=t?.activeSubscriptions?.some(u=>u.plan?.type==="regular"&&u.plan?.board===r&&u.plan?.classes?.includes(parseInt(i))&&new Date(u.endDate)>new Date)||t?.subscription?.status==="active"&&t?.subscription?.plan?.type==="regular"&&t?.subscription?.plan?.board===r&&t?.subscription?.plan?.classes?.includes(parseInt(i))&&new Date(t.subscription.endDate)>new Date,a&&(o=`You already have an active subscription for ${r} Class ${i}. Please wait until your current subscription expires before subscribing to another plan for the same class.`)}else if(n==="preparation"){const r=s.classId?._id||s.classId;r&&(a=t?.activeSubscriptions?.some(i=>{if(i.plan?.type!=="preparation"||!i.plan?.classId)return!1;const u=i.plan.classId._id||i.plan.classId;return u&&u.toString()===r.toString()&&new Date(i.endDate)>new Date}),a&&(o=`You already have an active subscription for ${s.classId?.name||"this preparation class"}. Please wait until your current subscription expires before subscribing to another plan for the same preparation class.`))}if(a){p(o),alert(o),x(null);return}if(localStorage.getItem("payment_in_progress")==="true")if(Date.now()-parseInt(localStorage.getItem("payment_timestamp")||0)<300*1e3){p("A payment is already in progress. Please complete it or wait a few minutes before trying again."),x(null),alert("A payment is already in progress. Please wait a moment and try again.");return}else localStorage.removeItem("payment_in_progress"),localStorage.removeItem("payment_order_id"),localStorage.removeItem("payment_timestamp");console.log("Step 1: Creating Cashfree order for plan:",s._id);let m;try{m=await q.createOrder(s._id),console.log("Order Response:",m)}catch(r){if(console.error("=== API ERROR DETAILS ==="),console.error("API Error:",r),console.error("Error Status:",r.status),console.error("Error Message:",r.message),console.error("Error Data:",r.data),r.status===429){const u="You already have a pending payment for this plan. Please wait a moment before trying again.";p(u),x(null),alert(u);return}const i=r.message||"Failed to create payment order. Please try again.";p(i),x(null),alert(i);return}if(!m)throw console.error("No response received from API"),new Error("No response from server. Please try again.");if(!m.success)throw console.error("Order creation failed:",m),new Error(m.message||"Failed to create payment order");if(!m.data)throw console.error("Order response data missing:",m),new Error("Invalid response from server");const{orderId:y,paymentSessionId:f,amount:g,currency:b,clientId:h,environment:l}=m.data;if(!y||!f||!g||!h)throw console.error("Missing required payment data:",{orderId:y,paymentSessionId:f,amount:g,clientId:h}),new Error("Invalid payment data received");if(console.log("Step 2: Checking Cashfree SDK availability..."),!window.Cashfree&&!window.cashfree){const r="Cashfree payment gateway is not available. Please refresh the page and try again.";console.error(r),p(r),x(null),alert(r);return}console.log("Step 3: Initializing Cashfree checkout...",{orderId:y,paymentSessionId:f,amount:g,currency:b,clientId:h}),localStorage.setItem("payment_in_progress","true"),localStorage.setItem("payment_order_id",y),localStorage.setItem("payment_timestamp",Date.now().toString()),console.log("Payment flags set in localStorage");try{const r=window.Cashfree||window.cashfree,i=new r({mode:"production"}),u={paymentSessionId:f,redirectTarget:"_self"};i.checkout(u).then(N=>{if(N.error){localStorage.removeItem("payment_in_progress"),localStorage.removeItem("payment_order_id"),localStorage.removeItem("payment_timestamp"),alert(N.error.message||"Payment failed"),x(null);return}x(null)}).catch(N=>{localStorage.removeItem("payment_in_progress"),localStorage.removeItem("payment_order_id"),localStorage.removeItem("payment_timestamp"),alert(N.message||"Payment failed"),x(null)})}catch(r){console.error("Error initializing Cashfree checkout:",r),localStorage.removeItem("payment_in_progress"),localStorage.removeItem("payment_order_id"),localStorage.removeItem("payment_timestamp"),p(r.message||"Failed to initialize payment gateway"),x(null),alert(r.message||"Failed to initialize payment gateway. Please try again.")}}catch(n){console.error("=== PAYMENT ERROR ==="),console.error("Error:",n),console.error("Error message:",n.message),console.error("Error stack:",n.stack),p(n.message||"Failed to initiate payment"),x(null),alert(n.message||"Failed to initiate payment. Please try again.")}},R=S.reduce((s,n)=>{const a=n.type||"regular";let o;if(a==="regular")o=`${a}_${n.duration}`;else{const I=n.classId?._id||n.classId||"unknown";o=`${a}_${I}_${n.duration}`}return s[o]||(s[o]={type:a,duration:n.duration,prepClassName:a==="preparation"?n.classId?.name||"Preparation Class":null,prepClassId:a==="preparation"?n.classId?._id||n.classId:null,plans:[]}),s[o].plans.push(n),s},{}),O=Object.values(R).sort((s,n)=>{if(s.type!==n.type)return s.type==="regular"?-1:1;const a=["monthly","quarterly","half_yearly","yearly","demo"];return a.indexOf(s.duration)-a.indexOf(n.duration)});return e.jsxs("div",{className:"min-h-screen w-full bg-white pb-20",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-[var(--app-dark-blue)] text-white relative",style:{borderRadius:"0 0 50% 50% / 0 0 30px 30px"},children:e.jsx("div",{className:"px-4 sm:px-6 pt-3 sm:pt-4 pb-4 sm:pb-5",children:e.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[e.jsx("button",{onClick:()=>E(B.DASHBOARD),className:"p-2 text-white hover:bg-white/10 rounded-full transition-colors",children:e.jsx(T,{className:"text-lg sm:text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-lg sm:text-xl md:text-2xl font-bold",children:"Subscription Plans"}),e.jsx("p",{className:"text-xs sm:text-sm text-white/90 mt-0.5",children:d&&c?`${d} - Class ${c} & Preparation Classes`:"Loading..."})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 md:px-8 py-4 sm:py-5 pb-24",children:[A?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px]",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-[var(--app-orange)] mb-3"}),e.jsx("p",{className:"text-[var(--app-black)]/70 text-sm",children:"Loading subscription plans..."})]}):j?e.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-lg border border-red-200 text-center",children:[e.jsx("p",{className:"text-red-600 mb-4 text-sm sm:text-base",children:j}),e.jsx("button",{onClick:D,className:"bg-gradient-to-r from-[var(--app-dark-blue)] to-[var(--app-dark-blue)]/90 text-white font-bold px-6 py-2.5 rounded-xl hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5 text-sm",children:"Retry"})]}):S.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] bg-white rounded-xl sm:rounded-2xl p-6 sm:p-8 shadow-lg border border-gray-200",children:[e.jsx("div",{className:"w-16 h-16 sm:w-20 sm:h-20 bg-[var(--app-dark-blue)]/10 rounded-full flex items-center justify-center mb-4",children:e.jsx(z,{className:"text-[var(--app-dark-blue)] text-2xl sm:text-3xl"})}),e.jsx("h3",{className:"text-lg sm:text-xl font-bold text-[var(--app-black)] mb-2",children:"No Plans Available"}),e.jsxs("p",{className:"text-[var(--app-black)]/70 text-center max-w-md text-xs sm:text-sm",children:["No subscription plans are currently available for ",d," Class ",c," or preparation classes."]})]}):e.jsx("div",{className:"space-y-5 sm:space-y-6",children:O.map(s=>s.plans.length===0?null:(s.type==="preparation"?`${s.prepClassName||"Preparation Class"}${C(s.duration)}`:`${C(s.duration)}`,e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5",children:s.plans.map(a=>{const o=a.originalPrice&&a.originalPrice>a.price,I=o?Math.round((a.originalPrice-a.price)/a.originalPrice*100):0,m=a.type||"regular",y=m==="preparation",f=a.isDisabled||!1;let g=!1,b=null;if(m==="regular")g=t?.activeSubscriptions?.some(l=>l.plan?.type==="regular"&&l.plan?.board===d&&l.plan?.classes?.includes(parseInt(c))&&new Date(l.endDate)>new Date)||t?.subscription?.status==="active"&&t?.subscription?.plan?.type==="regular"&&t?.subscription?.plan?.board===d&&t?.subscription?.plan?.classes?.includes(parseInt(c))&&new Date(t.subscription.endDate)>new Date,b=t?.activeSubscriptions?.find(l=>l.plan?.type==="regular"&&l.plan?.board===d&&l.plan?.classes?.includes(parseInt(c))&&new Date(l.endDate)>new Date)||(t?.subscription?.status==="active"&&t?.subscription?.plan?.type==="regular"&&t?.subscription?.plan?.board===d&&t?.subscription?.plan?.classes?.includes(parseInt(c))&&new Date(t.subscription.endDate)>new Date?t.subscription:null);else if(m==="preparation"){const l=a.classId?._id||a.classId;g=t?.activeSubscriptions?.some(r=>r.plan?.type==="preparation"&&r.plan?.classId&&(r.plan.classId._id?.toString()===l?.toString()||r.plan.classId.toString()===l?.toString())&&new Date(r.endDate)>new Date),b=t?.activeSubscriptions?.find(r=>r.plan?.type==="preparation"&&r.plan?.classId&&(r.plan.classId._id?.toString()===l?.toString()||r.plan.classId.toString()===l?.toString())&&new Date(r.endDate)>new Date)}const h=f||g;return e.jsxs("div",{className:`bg-white rounded-xl sm:rounded-2xl p-4 sm:p-5 shadow-md transition-all duration-300 border relative ${h?"opacity-60 border-gray-300 cursor-not-allowed":"hover:shadow-lg hover:border-[var(--app-dark-blue)]/30 border-gray-200"}`,children:[o&&!h&&e.jsxs("div",{className:"absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-md shadow-md z-10",children:[I,"% OFF"]}),h&&e.jsxs("div",{className:"absolute top-2 right-2 bg-gray-500 text-white text-xs font-bold px-2 py-0.5 rounded-md shadow-md z-10 flex items-center gap-1",children:[e.jsx(Y,{className:"text-xs"}),g?"Already Subscribed":"Disabled"]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-[var(--app-black)] mb-1",children:a.name}),e.jsx("p",{className:"text-xs sm:text-sm text-[var(--app-black)]/60",children:y?a.classId?.name||"Preparation Class":`${d||a.board} â€¢ Class ${c||a.classes?.join(", ")}`})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-baseline gap-2 mb-0.5",children:[e.jsx("span",{className:"text-2xl sm:text-3xl font-bold text-[var(--app-dark-blue)]",children:_(a.price)}),o&&e.jsx("span",{className:"text-sm sm:text-base text-gray-400 line-through",children:_(a.originalPrice)})]}),e.jsxs("p",{className:"text-xs text-[var(--app-black)]/60",children:["per ",s.duration==="monthly"?"month":s.duration==="quarterly"?"3 months":s.duration==="half_yearly"?"6 months":s.duration==="demo"?`${a.validityDays||7} days`:"year"]})]}),h?e.jsxs("div",{className:"w-full",children:[e.jsx("button",{disabled:!0,className:"w-full bg-gray-300 text-white font-bold py-2.5 rounded-lg cursor-not-allowed text-sm",children:g?"Already Subscribed":"Not Available"}),b&&e.jsxs("p",{className:"text-xs text-[var(--app-black)]/70 mt-1.5 text-center",children:["Expires on"," ",e.jsx("span",{className:"font-semibold text-[var(--app-dark-blue)]",children:new Date(b.endDate||b.plan?.endDate||t.subscription.endDate).toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"})})]}),a.disabledReason&&!g&&e.jsx("p",{className:"text-xs text-red-600 mt-1.5 text-center",children:a.disabledReason})]}):e.jsx("button",{onClick:l=>{l.preventDefault(),l.stopPropagation(),console.log("Button clicked for plan:",a._id),$(a)},disabled:P===a._id||h,className:"w-full bg-gradient-to-r from-[var(--app-dark-blue)] to-[var(--app-teal)] text-white font-bold py-2.5 rounded-lg hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-sm",children:P===a._id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:["Subscribe Now",e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})})]})})]},a._id)})})},`${s.type}_${s.duration}`)))}),S.length>0&&e.jsx("div",{className:"mt-5 sm:mt-6 bg-gradient-to-r from-[var(--app-dark-blue)]/5 via-[var(--app-teal)]/5 to-[var(--app-dark-blue)]/5 rounded-xl sm:rounded-2xl p-4 sm:p-5 border-2 border-[var(--app-dark-blue)]/10 shadow-md",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-[var(--app-dark-blue)] to-[var(--app-teal)] rounded-lg flex items-center justify-center shadow-md",children:e.jsx(U,{className:"text-white text-lg sm:text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-base sm:text-lg text-[var(--app-black)] mb-1.5",children:"Why Subscribe?"}),e.jsx("p",{className:"text-xs sm:text-sm text-[var(--app-black)]/70 leading-relaxed",children:"Get access to all courses, live classes, recorded sessions, and exclusive content for your class, board, and preparation classes."})]})]})})]})]})};export{K as default};
