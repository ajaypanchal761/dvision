import{u as ae,q as re,r as o,j as e,F as le}from"./index-BPKQ2keO.js";import{c as ne,s as I,b as A}from"./api-BdrZRD_7.js";const ue=()=>{const x=ae(),{id:b}=re(),[s,d]=o.useState({image:null,imagePreview:null,name:"",email:"",mobile:"",class:"",board:"CBSE",password:"",status:"Active",subscriptionStatus:"none",selectedPlanId:"",prepSubscriptions:{}}),[u,f]=o.useState(!1),[G,k]=o.useState(!0),[E,m]=o.useState(""),[B,L]=o.useState([]),[h,D]=o.useState([]),[F,K]=o.useState([]),[oe,V]=o.useState({}),[v,M]=o.useState(!0),[j,_]=o.useState("+91"),[U,w]=o.useState(!1),[Y,J]=o.useState([]),[N,y]=o.useState([]),[S,q]=o.useState(!1),[ie,C]=o.useState([]),[R,z]=o.useState(!1),[W,Q]=o.useState([]),[X,P]=o.useState({}),T=[{code:"+91",country:"India",countryCode:"IN",flag:"ðŸ‡®ðŸ‡³"},{code:"+1",country:"USA",countryCode:"US",flag:"ðŸ‡ºðŸ‡¸"},{code:"+44",country:"UK",countryCode:"GB",flag:"ðŸ‡¬ðŸ‡§"},{code:"+61",country:"Australia",countryCode:"AU",flag:"ðŸ‡¦ðŸ‡º"},{code:"+971",country:"UAE",countryCode:"AE",flag:"ðŸ‡¦ðŸ‡ª"}],Z=t=>{if(!t)return{code:"+91",number:""};for(const r of T)if(t.startsWith(r.code))return{code:r.code,number:t.substring(r.code.length)};return{code:"+91",number:t}};o.useEffect(()=>{(async()=>{try{M(!0);const r=await ne.getAllWithoutPagination({isActive:!0});if(r.success&&r.data?.classes){const n=r.data.classes;K(n);const l={};n.filter(i=>i.type==="preparation").forEach(i=>{l[i._id]=i.name||i.classCode||"Preparation Class"}),V(l);const c=[...new Set(n.filter(i=>i.type==="regular").map(i=>i.board))].filter(Boolean).sort();L(c)}const a=await I.getAll();if(a.success&&a.data?.students){const n=a.data.students.filter(l=>l._id!==b).map(l=>l.phone||"").filter(Boolean);J(n)}}catch(r){console.error("Error fetching data:",r),L([])}finally{M(!1)}})()},[b]),o.useEffect(()=>{if(!s.board){D([]);return}const t=s.board.trim(),r=[...new Set(F.filter(a=>(a.board||"").trim().toLowerCase()===t.toLowerCase()&&a.type==="regular"&&a.class!=null).map(a=>parseInt(a.class)).filter(a=>!isNaN(a)&&a>=1&&a<=12))].sort((a,n)=>a-n);if(D(r),s.class){const a=parseInt(s.class);r.includes(a)||d(n=>({...n,class:""}))}},[s.board,F]),o.useEffect(()=>{(async()=>{if(s.subscriptionStatus==="active"&&s.class&&s.board)try{q(!0);const r=parseInt(s.class),a=await A.getAll({class:r,board:s.board,isActive:!0,type:"regular"});if(a.success&&(a.data?.plans||a.data?.subscriptionPlans)){const n=a.data.plans||a.data.subscriptionPlans||[];y(n)}else y([])}catch(r){console.error("Error fetching subscription plans:",r),y([])}finally{q(!1)}else y([]),s.subscriptionStatus==="none"&&d(r=>({...r,selectedPlanId:""}))})()},[s.subscriptionStatus,s.class,s.board]),o.useEffect(()=>{(async()=>{try{z(!0);const r=await A.getPreparationClasses(!0);if(r.success&&r.data?.classes){const n=r.data.classes.filter(l=>l.isActive!==!1);Q(n)}const a=await A.getAll({type:"preparation",isActive:!0});if(a.success&&(a.data?.plans||a.data?.subscriptionPlans)){const n=a.data.plans||a.data.subscriptionPlans||[];C(n);const l={};n.forEach(c=>{const i=c.classId?._id||c.classId;if(i){const g=i.toString();l[g]||(l[g]=[]),l[g].push(c)}}),P(l)}else C([]),P({})}catch(r){console.error("Error fetching preparation data:",r),C([]),P({})}finally{z(!1)}})()},[]),o.useEffect(()=>{b&&(async()=>{try{k(!0),m("");const r=await I.getById(b);if(r.success&&r.data?.student){const a=r.data.student,{code:n,number:l}=Z(a.phone||"");_(n);const c=a.subscription&&a.subscription.status==="active"&&a.subscription.planId,i=c?"active":"none",g=c&&a.subscription.planId?a.subscription.planId.toString():"",$={};Array.isArray(a.activeSubscriptions)&&a.activeSubscriptions.filter(p=>p.type==="preparation"&&p.planId&&p.classId).forEach(p=>{const H=p.classId?._id||p.classId,O=p.planId?._id||p.planId;H&&O&&($[H.toString()]=O.toString())}),d({name:a.name||"",email:a.email||"",mobile:l,class:a.class?String(a.class):"",board:a.board||"",password:"",status:a.isActive?"Active":"Inactive",imagePreview:a.profileImage||null,subscriptionStatus:i,selectedPlanId:g,prepSubscriptions:$})}else m("Student not found"),setTimeout(()=>x("/admin/students"),2e3)}catch(r){m(r.message||"Failed to load student"),console.error("Error fetching student:",r),setTimeout(()=>x("/admin/students"),2e3)}finally{k(!1)}})()},[b,x]);const ee=t=>{const r=t.target.files[0];if(r){const a=new FileReader;a.onloadend=()=>{d({...s,image:r,imagePreview:a.result})},a.readAsDataURL(r)}},se=async t=>{t.preventDefault(),m(""),f(!0);try{const r=s.mobile.replace(/\D/g,"");if(!r||r.length<10){m("Please enter a valid mobile number (minimum 10 digits)"),f(!1);return}if(r.length>15){m("Mobile number cannot exceed 15 digits"),f(!1);return}const a=`${j}${r}`;if(Y.includes(a)){m("This mobile number is already registered. Please use a different number."),f(!1);return}const n=parseInt(s.class);if(isNaN(n)||!h.includes(n))throw new Error("Please select a valid class for the selected board");if(s.password&&s.password.length<6){m("Password must be at least 6 characters long"),f(!1);return}const l={name:s.name.trim(),phone:a,email:s.email?s.email.trim():"",class:n,board:s.board.trim(),isActive:s.status==="Active"};s.password&&(l.password=s.password),s.subscriptionStatus==="active"&&s.selectedPlanId?l.subscriptionPlanId=s.selectedPlanId:s.subscriptionStatus==="none"&&(l.removeSubscription=!0);const c=Object.values(s.prepSubscriptions||{}).filter(Boolean);c.length>0&&(l.preparationPlanIds=c),s.imagePreview&&s.image&&(l.profileImageBase64=s.imagePreview);const i=await I.update(b,l);i.success?x("/admin/students"):m(i.message||"Failed to update student")}catch(r){m(r.message||"Failed to update student. Please try again."),console.error("Error updating student:",r)}finally{f(!1)}},te=t=>t?t.split(" ").map(r=>r[0]).join("").toUpperCase().slice(0,2):"ST";return G?e.jsx("div",{className:"min-h-screen bg-white flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 sm:h-10 sm:w-10 border-b-2 border-[#1e3a5f]"}),e.jsx("p",{className:"mt-2 sm:mt-3 text-gray-500 text-xs sm:text-sm",children:"Loading student data..."})]})}):e.jsx("div",{className:"min-h-screen bg-white",children:e.jsxs("div",{className:"px-4 sm:px-6 lg:px-8 pt-2 sm:pt-3",children:[e.jsx("div",{className:"pb-1 sm:pb-2",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("button",{onClick:()=>x("/admin/students"),className:"text-[#1e3a5f] hover:text-[#2a4a6f] transition-colors",children:e.jsx("svg",{className:"w-4 h-4 sm:w-5 sm:h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})})}),e.jsx("h1",{className:"text-sm sm:text-base md:text-lg lg:text-xl font-bold text-[#1e3a5f]",children:"Edit Student"})]})}),E&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-xs sm:text-sm mt-2 sm:mt-3",children:E}),e.jsx("div",{className:"mt-2 sm:mt-3",children:e.jsxs("form",{onSubmit:se,className:"space-y-3 sm:space-y-4",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4 md:p-5",children:e.jsx("div",{className:"flex items-center justify-center py-2 sm:py-3",children:e.jsxs("div",{className:"relative",children:[s.imagePreview?e.jsx("img",{src:s.imagePreview,alt:"Preview",className:"h-20 w-20 sm:h-24 sm:w-24 rounded-full object-cover border-4 border-[#1e3a5f] shadow-lg"}):e.jsx("div",{className:"h-20 w-20 sm:h-24 sm:w-24 rounded-full bg-linear-to-br from-[#1e3a5f] to-[#2a4a6f] flex items-center justify-center border-4 border-[#1e3a5f] shadow-lg",children:e.jsx("span",{className:"text-white font-bold text-lg sm:text-xl",children:te(s.name)})}),e.jsxs("label",{className:"absolute bottom-0 right-0 bg-linear-to-r from-[#1e3a5f] to-[#2a4a6f] hover:from-[#2a4a6f] hover:to-[#1e3a5f] text-white rounded-full p-2 sm:p-2.5 cursor-pointer transition-all duration-200 shadow-lg hover:shadow-xl",children:[e.jsxs("svg",{className:"w-4 h-4 sm:w-5 sm:h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:ee,className:"hidden",disabled:u})]})]})})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4 md:p-5",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Full Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",required:!0,value:s.name,onChange:t=>d({...s,name:t.target.value}),className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200",placeholder:"Enter full name",disabled:u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:"Email"}),e.jsx("input",{type:"email",value:s.email,onChange:t=>d({...s,email:t.target.value}),className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200",placeholder:"Enter email address",disabled:u})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Password ",e.jsx("span",{className:"text-gray-500 text-[10px]",children:"(Optional - leave empty to keep current password, min 6 characters to change)"})]}),e.jsx("input",{type:"password",value:s.password,onChange:t=>d({...s,password:t.target.value}),className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200",placeholder:"Enter new password (optional)",disabled:u,minLength:6}),s.password&&s.password.length>0&&s.password.length<6&&e.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:"Password must be at least 6 characters"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Mobile ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative flex items-stretch",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsxs("button",{type:"button",onClick:()=>w(!U),className:"flex items-center justify-center gap-1.5 px-3 py-2 rounded-l-lg border-2 border-r-0 border-gray-200 bg-gray-50 hover:bg-gray-100 transition-colors text-xs sm:text-sm",children:[e.jsx("span",{className:"text-gray-700 font-medium whitespace-nowrap",children:j}),e.jsx(le,{className:"text-gray-500 text-xs shrink-0"})]}),U&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>w(!1)}),e.jsx("div",{className:"absolute top-full left-0 mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-2xl z-20 max-h-60 overflow-y-auto w-56",children:T.map(t=>e.jsxs("button",{type:"button",onClick:()=>{_(t.code),w(!1)},className:`w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-50 transition-colors text-xs ${j===t.code?"bg-[#1e3a5f]/10":""}`,children:[e.jsx("span",{className:"text-gray-700 font-bold w-8",children:t.countryCode}),e.jsx("span",{className:"text-gray-700 font-medium",children:t.code}),e.jsx("span",{className:"text-gray-500 text-[10px] ml-auto",children:t.country})]},t.code))})]})]}),e.jsx("input",{type:"tel",required:!0,value:s.mobile,onChange:t=>{const r=t.target.value.replace(/\D/g,"").slice(0,15);d({...s,mobile:r})},autoComplete:"off",autoCapitalize:"off",autoCorrect:"off",spellCheck:"false",inputMode:"numeric",className:"flex-1 pl-3 pr-3 py-2 rounded-r-lg border-2 border-gray-200 bg-gray-50 focus:outline-none focus:border-[#1e3a5f] focus:ring-2 focus:ring-[#1e3a5f]/20 focus:bg-white transition-all text-xs sm:text-sm text-gray-700 placeholder:text-gray-400",placeholder:"Enter mobile number",disabled:u})]}),s.mobile&&s.mobile.length<10&&e.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:"Mobile number must be at least 10 digits"}),s.mobile&&s.mobile.length>15&&e.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:"Mobile number cannot exceed 15 digits"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Board ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{required:!0,value:s.board,onChange:t=>{d({...s,board:t.target.value,class:""})},className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white",disabled:u||v,children:[e.jsx("option",{value:"",children:"Select Board"}),B.map(t=>e.jsx("option",{value:t,children:t},t))]}),v&&e.jsx("p",{className:"text-[10px] text-gray-500 mt-1",children:"Loading boards..."}),!v&&B.length===0&&e.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:"No boards available. Please create classes first."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Class ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{required:!0,value:s.class,onChange:t=>d({...s,class:t.target.value}),className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white",disabled:u||!s.board||h.length===0,children:[e.jsx("option",{value:"",children:s.board?"Select Class":"Select Board First"}),h.map(t=>e.jsxs("option",{value:t,children:["Class ",t]},t))]}),s.board&&h.length===0&&!v&&e.jsxs("p",{className:"text-[10px] text-red-500 mt-1",children:["No classes available for ",s.board,". Please create a class-board combination first."]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2",children:["Status ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{required:!0,value:s.status,onChange:t=>d({...s,status:t.target.value}),className:"w-full px-3 py-2 text-xs sm:text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white",disabled:u,children:[e.jsx("option",{value:"Active",children:"Active"}),e.jsx("option",{value:"Inactive",children:"Inactive"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-[10px] sm:text-xs font-semibold text-gray-700 mb-0.5 sm:mb-1",children:["Subscription Status ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{required:!0,value:s.subscriptionStatus,onChange:t=>d({...s,subscriptionStatus:t.target.value,selectedPlanId:""}),className:"w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-200 rounded-lg focus:ring-1 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white text-[10px] sm:text-xs",disabled:u,children:[e.jsx("option",{value:"none",children:"None"}),e.jsx("option",{value:"active",children:"Active"})]})]}),s.subscriptionStatus==="active"&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsxs("label",{className:"block text-[10px] sm:text-xs font-semibold text-gray-700 mb-0.5 sm:mb-1",children:["Subscription Plan ",!s.class||!s.board?"(Select Class & Board First)":""]}),e.jsxs("select",{value:s.selectedPlanId,onChange:t=>d({...s,selectedPlanId:t.target.value}),className:"w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-200 rounded-lg focus:ring-1 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white text-[10px] sm:text-xs",disabled:u||!s.class||!s.board||S,children:[e.jsx("option",{value:"",children:S?"Loading plans...":!s.class||!s.board?"Select Class & Board First":N.length===0?"No plans available":"Select Subscription Plan"}),N.map(t=>e.jsxs("option",{value:t._id,children:[t.name," - â‚¹",t.price," (",t.duration,")"]},t._id))]}),s.class&&s.board&&N.length===0&&!S&&e.jsxs("p",{className:"text-[9px] text-gray-500 mt-0.5",children:["No subscription plans available for Class ",s.class," - ",s.board]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-3 sm:p-4",children:[e.jsx("label",{className:"block text-[11px] sm:text-sm font-semibold text-gray-700 mb-1",children:"Preparation Subscriptions (optional)"}),e.jsx("p",{className:"text-[10px] sm:text-xs text-gray-500 mb-2",children:"Assign one subscription per preparation class. You can assign multiple subscriptions for different preparation classes."}),R?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Loading preparation classes..."})}):W.length===0?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-gray-500",children:"No preparation classes available"})}):e.jsx("div",{className:"space-y-3",children:W.map(t=>{const r=t._id?.toString()||t._id,a=X[r]||[],n=s.prepSubscriptions[r]||"";return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-2 sm:p-3",children:[e.jsx("label",{className:"block text-[10px] sm:text-xs font-semibold text-gray-700 mb-1.5",children:t.name||t.classCode||"Preparation Class"}),e.jsxs("select",{value:n,onChange:l=>{const c={...s.prepSubscriptions};l.target.value?c[r]=l.target.value:delete c[r],d(i=>({...i,prepSubscriptions:c}))},className:"w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-200 rounded-lg focus:ring-1 focus:ring-[#1e3a5f] focus:border-[#1e3a5f] outline-none transition-all duration-200 bg-white text-[10px] sm:text-xs",disabled:u||R,children:[e.jsx("option",{value:"",children:"No subscription"}),a.map(l=>e.jsxs("option",{value:l._id,children:[l.name," - â‚¹",l.price," (",l.duration,")"]},l._id))]}),a.length===0&&e.jsx("p",{className:"text-[9px] text-gray-400 mt-1",children:"No subscriptions available for this class"})]},r)})})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-2 sm:gap-3 pt-3 sm:pt-4",children:[e.jsx("button",{type:"button",onClick:()=>x("/admin/students"),disabled:u,className:"w-full sm:w-auto px-4 sm:px-6 py-2 text-xs sm:text-sm border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-all duration-200 disabled:opacity-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:u,className:"w-full sm:w-auto px-4 sm:px-6 py-2 text-xs sm:text-sm bg-linear-to-r from-[#1e3a5f] to-[#2a4a6f] hover:from-[#2a4a6f] hover:to-[#1e3a5f] text-white rounded-lg font-semibold transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50",children:u?"Updating...":"Update Student"})]})]})})]})})};export{ue as default};
