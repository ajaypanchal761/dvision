import{aj as We,u as Ke,q as Ye,r as f,j as n,c as Ze,aB as Je,X as Qe,aH as xe,T as ae,aI as er,aJ as rr,U as tr,V as sr,W as nr,h as or,Y as ar}from"./index-BPKQ2keO.js";import{l as ir,P as Se,A as M}from"./index-DXNgcvxb.js";import{l as P}from"./api-CVReUq8b.js";function cr(v){return We({attr:{viewBox:"0 0 24 24",fill:"currentColor"},child:[{tag:"path",attr:{d:"M9.82843 5L7.82843 7H4V19H20V7H16.1716L14.1716 5H9.82843ZM9 3H15L17 5H21C21.5523 5 22 5.44772 22 6V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V6C2 5.44772 2.44772 5 3 5H7L9 3ZM9.64042 7.53044C10.3555 7.19033 11.1555 7 12 7C15.0376 7 17.5 9.46243 17.5 12.5C17.5 14.05 16.8588 15.4502 15.8273 16.4499L13.75 12.6H15.4986C15.4995 12.5668 15.5 12.5334 15.5 12.5C15.5 10.567 13.933 9 12 9C11.4912 9 11.0078 9.10856 10.5716 9.30378L9.64042 7.53044ZM14.3175 17.4894C13.6132 17.817 12.828 18 12 18C8.96243 18 6.5 15.5376 6.5 12.5C6.5 10.9678 7.12654 9.58193 8.13738 8.58462L10.25 12.5H8.5C8.5 14.433 10.067 16 12 16C12.4923 16 12.9608 15.8984 13.3857 15.715L14.3175 17.4894Z"},child:[]}]})(v)}const lr=()=>{{const h="http://localhost:5000/api".replace(/\/$/,"");return console.log("[Teacher Socket] Using VITE_API_BASE_URL from env:",h),h}},Ie=lr(),dr=()=>{try{{const C="http://localhost:5000/".replace(/\/$/,"");return console.log("[Teacher Socket] Using VITE_SOCKET_URL:",C),C}let v=Ie;if(v=v.replace(/\/api\/?$/,""),v=v.replace(/\/$/,""),v.startsWith("http://")||v.startsWith("https://")){const C=new URL(v),q=`${C.protocol}//${C.host}`;return console.log("[Teacher Socket] Socket URL determined:",q,"from API URL:",Ie),q}const h="http://localhost:5000";return console.log("[Teacher Socket] Using default socket URL:",h),h}catch(v){return console.error("[Teacher Socket] Error parsing URL, using default:",v),"http://localhost:5000"}},ke=dr();console.log("[Teacher Socket] Final SOCKET_URL:",ke);const mr=()=>{const v=Ke(),{id:h}=Ye(),[C,q]=f.useState(null),[Ce,ie]=f.useState(!0),[ce,w]=f.useState(""),[_,Re]=f.useState(!1),[R,le]=f.useState(!0),[V,de]=f.useState("user"),[ue,k]=f.useState(!1),[Ee,$]=f.useState([]),[J,ge]=f.useState(""),[G,W]=f.useState(!1),[Q,K]=f.useState(!1),[je,A]=f.useState([]),[fe,me]=f.useState([]),[L,ee]=f.useState(0),re=()=>{const e=localStorage.getItem("dvision_teacher_token");if(e)try{return JSON.parse(atob(e.split(".")[1])).id}catch(s){console.error("Error parsing token:",s)}return null},Te=e=>{const s=re();return s?e.filter(t=>(t.userId?._id?.toString()||t.userId?.toString()||t.userId)===s?.toString()?!1:!(t.readBy&&t.readBy.some(l=>l.userId?.toString()===s?.toString()))).length:0},te=f.useRef(null),I=f.useRef(null),m=f.useRef(null),x=f.useRef(null),F=f.useRef({}),y=f.useRef(null),b=f.useRef(null),E=f.useRef([]),[se,z]=f.useState(!1),g=f.useRef(null),[O,j]=f.useState("disconnected"),[he,pe]=f.useState(!0),H=f.useRef(null),Y=f.useCallback(()=>{H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{pe(!1)},2e3)},[]),ne=f.useCallback(()=>{pe(!0),Y()},[Y]);f.useEffect(()=>{let e=!0;return(async()=>{await D(),e&&await Ne()})(),Y(),()=>{e=!1,D(),H.current&&clearTimeout(H.current)}},[h,Y]),f.useEffect(()=>{const e=()=>{if(y.current){const r=y.current.querySelector("video")||(y.current.tagName==="VIDEO"?y.current:null);if(r){r.style.objectFit="contain",r.style.width="100%",r.style.height="100%",r.style.maxWidth="100%",r.style.maxHeight="100%",r.style.position="absolute",r.style.top="50%",r.style.left="50%",r.style.backgroundColor="black";const a=V==="user"?"scaleX(-1)":"scaleX(1)";r.style.transform=`translate(-50%, -50%) ${a}`,r.style.transition="transform 0.2s ease-in-out",console.log("Applied video styling and transform for camera facing:",V)}}};e();const s=setTimeout(e,200),t=setInterval(e,1e3);return()=>{clearTimeout(s),clearInterval(t)}},[V,R]),f.useEffect(()=>{if(m.current&&y.current&&O==="connected"&&R){const e=()=>{if(y.current&&m.current&&m.current.enabled)try{const s=m.current.play(y.current);s&&typeof s.then=="function"?s.then(()=>{console.log("Local video playing successfully in useEffect"),setTimeout(()=>{const t=y.current?.querySelector("video");t&&(t.style.transform=V==="user"?"scaleX(-1)":"scaleX(1)",t.style.transition="transform 0.2s ease-in-out")},100),k(!1)}).catch(t=>{console.error("Error playing local video in useEffect:",t),R&&m.current&&m.current.enabled&&setTimeout(e,200)}):(console.log("Video play returned non-promise, assuming success"),setTimeout(()=>{const t=y.current?.querySelector("video");t&&(t.style.transform=V==="user"?"scaleX(-1)":"scaleX(1)",t.style.transition="transform 0.2s ease-in-out")},100),k(!1))}catch(s){console.error("Error calling play on local video in useEffect:",s),R&&m.current&&m.current.enabled&&setTimeout(e,200)}};e()}},[O,R,V]);const ye=f.useCallback(()=>{g.current&&(g.current.removeAllListeners(),g.current.disconnect(),g.current=null);const e=localStorage.getItem("dvision_teacher_token");if(!e){console.error("No auth token found"),w("Session expired. Please log in again."),v("/teacher/login",{replace:!0});return}const s=ke||"http://localhost:5000";console.log("[Socket] Connecting to:",s,"with token:",e?"Present":"Missing");const t=ir(s,{auth:{token:e},transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:10,path:"/socket.io/",autoConnect:!0,forceNew:!1,timeout:6e4});return t.on("connect",()=>{console.log("Teacher socket connected"),j("connected"),k(!1),t.emit("join-live-class",{liveClassId:h}),console.log("Teacher joined live class room:",h)}),t.on("disconnect",()=>{console.log("Socket disconnected"),j("disconnected"),k(O==="connected")}),t.on("connect_error",r=>{console.error("Socket connection error:",r),console.error("Socket error details:",{message:r.message,type:r.type,description:r.description,context:r.context,socketUrl:s}),k(O==="connected"),r.message&&r.message.includes("namespace")&&(console.warn("[Socket] Namespace error detected. Check if Socket.io server is running on:",s),console.warn("[Socket] Make sure the server URL does not include /api path"))}),t.on("reconnect",()=>{console.log("Socket reconnected"),k(!1),t.emit("join-live-class",{liveClassId:h}),setTimeout(()=>{Ue()},500)}),t.on("chat-message",r=>{console.log("Teacher received chat message:",r),console.log("Message details:",{userId:r.userId,userName:r.userName,userType:r.userType,message:r.message,messageId:r._id}),$(a=>{const o=a.filter(p=>{if(p._id&&p._id.toString().startsWith("temp-")){const S=p.userId?._id?.toString()||p.userId?.toString()||p.userId,N=r.userId?._id?.toString()||r.userId?.toString()||r.userId;return!(S===N&&p.message===r.message)}return!0});if(o.some(p=>{if(p._id&&r._id&&!p._id.toString().startsWith("temp-"))return p._id.toString()===r._id.toString();const S=p.userId?._id?.toString()||p.userId?.toString()||p.userId,N=r.userId?._id?.toString()||r.userId?.toString()||r.userId;return S===N&&p.message===r.message&&Math.abs(new Date(p.timestamp)-new Date(r.timestamp))<1e3}))return console.log("Duplicate message ignored"),o;const i=[...o,r],c=re(),d=r.userId?._id?.toString()||r.userId?.toString()||r.userId,u=c&&d&&c.toString()===d.toString();return!G&&!u&&ee(p=>p+1),setTimeout(()=>{te.current?.scrollIntoView({behavior:"smooth"})},100),i})}),t.on("user-joined",({userName:r,userRole:a})=>{console.log(`User joined: ${r} (${a})`),T()}),t.on("user-left",({userId:r,userName:a})=>{console.log(`User left: ${a}`),A(o=>o.filter(l=>(l.userId?._id?.toString()||l.userId?.toString()||l.userId)!==r?.toString())),setTimeout(()=>T(),500)}),t.on("student-kicked",({userId:r})=>{console.log(`Student ${r} was kicked`),T()}),t.on("participants-updated",({participants:r})=>{const a=(r||[]).filter((o,l,i)=>{const c=o.userId?._id?.toString()||o.userId?.toString()||o.userId;return i.findIndex(d=>(d.userId?._id?.toString()||d.userId?.toString()||d.userId)===c)===l}).filter(o=>!o.leftAt);A(o=>a.map(l=>{const i=l.userId?._id?.toString()||l.userId?.toString()||l.userId,c=o.find(d=>(d.userId?._id?.toString()||d.userId?.toString()||d.userId)===i);return{...l,hasRaisedHand:c?.hasRaisedHand||l.hasRaisedHand||!1}}))}),t.on("participant-status-updated",({userId:r,isMuted:a,isVideoEnabled:o})=>{console.log("Participant status updated:",r,"muted:",a,"video:",o),A(l=>l.map(i=>(i.userId?._id?.toString()||i.userId?.toString()||i.userId)===r?.toString()?{...i,isMuted:a!==void 0?a:i.isMuted,isVideoEnabled:o!==void 0?o:i.isVideoEnabled}:i)),setTimeout(()=>T(),500)}),t.on("hand-raise-updated",({userId:r,userName:a,hasRaisedHand:o})=>{console.log("Teacher received hand-raise-updated:",{userId:r,userName:a,hasRaisedHand:o});const l=r?.toString();me(o?i=>i.find(d=>d.userId?.toString()===l)?i:(console.log("Adding student to hand raised list:",a),[...i,{userId:l,userName:a}]):i=>{const c=i.filter(d=>d.userId?.toString()!==l);return console.log("Removing student from hand raised list:",a),c}),A(i=>i.map(c=>(c.userId?._id?.toString()||c.userId?.toString()||c.userId)===l?{...c,hasRaisedHand:o}:c))}),t.on("error",({message:r})=>{console.error("Socket error:",r)}),g.current=t,t.connected&&(console.log("Teacher socket already connected, joining room"),t.emit("join-live-class",{liveClassId:h})),t},[h]),Ue=async()=>{try{const e=await P.getLiveClass(h);if(e.success&&e.data?.liveClass){const t=(e.data.liveClass.chatMessages||[]).filter((r,a,o)=>{if(r._id)return o.findIndex(i=>i._id?.toString()===r._id.toString())===a;const l=r.userId?._id?.toString()||r.userId?.toString()||r.userId;return o.findIndex(i=>(i.userId?._id?.toString()||i.userId?.toString()||i.userId)===l&&i.message===r.message&&Math.abs(new Date(i.timestamp)-new Date(r.timestamp))<1e3)===a});$(t)}}catch(e){console.error("Error refreshing chat messages:",e)}},T=async()=>{try{const e=await P.getLiveClass(h);if(e.success&&e.data?.liveClass){const t=(e.data.liveClass.participants||[]).filter((r,a,o)=>{const l=r.userId?._id?.toString()||r.userId?.toString()||r.userId;return o.findIndex(i=>(i.userId?._id?.toString()||i.userId?.toString()||i.userId)===l)===a}).filter(r=>!r.leftAt);A(t)}}catch(e){console.error("Error refreshing participants:",e)}},Ne=async()=>{try{ie(!0),w(""),j("connecting");const e=await P.joinLiveClass(h);if(e.success&&e.data){const{liveClass:s,agoraToken:t,agoraAppId:r,agoraChannelName:a,agoraUid:o,unreadMessageCount:l}=e.data;q(s);const c=(s.chatMessages||[]).filter((S,N,Z)=>{if(S._id)return Z.findIndex(U=>U._id?.toString()===S._id.toString())===N;const oe=S.userId?._id?.toString()||S.userId?.toString()||S.userId;return Z.findIndex(U=>(U.userId?._id?.toString()||U.userId?.toString()||U.userId)===oe&&U.message===S.message&&U.timestamp===S.timestamp)===N});$(c);const d=l!==void 0?l:Te(c);ee(d);const p=(s.participants||[]).filter((S,N,Z)=>{const oe=S.userId?._id?.toString()||S.userId?.toString()||S.userId;return Z.findIndex(U=>(U.userId?._id?.toString()||U.userId?.toString()||U.userId)===oe)===N}).filter(S=>!S.leftAt);A(p),ye(),await Me(r,t,a,o)}else w("Failed to join class")}catch(e){console.error("Error initializing class:",e),w(e.message||"Failed to join class")}finally{ie(!1)}},Me=async(e,s,t,r)=>{try{const a=M.createClient({mode:"rtc",codec:"vp8",enableAudio:!0,enableVideo:!0});I.current=a,await M.setParameter("AUDIO_AINS_AGGRESSIVE","high"),await M.setParameter("AUDIO_AINS_STRENGTH","high"),a.on("user-published",Pe),a.on("user-unpublished",Ve),a.on("user-left",Le),a.on("connection-state-change",Fe),a.on("token-privilege-will-expire",ze),a.on("exception",o=>{[2001,2003,4003].includes(o.code)||console.warn("Agora exception:",o.code,o.msg)}),await a.join(e,t,s,r),console.log("Successfully joined Agora channel"),j("connected"),k(!1),await _e()}catch(a){throw console.error("Error initializing Agora:",a),w("Failed to initialize video/audio. Please check permissions."),a}},_e=async()=>{try{const e=await M.createMicrophoneAudioTrack({encoderConfig:"speech_standard",AEC:!0,ANS:!0,AGC:!0});x.current=e,await e.setVolume(100);const t=(await M.getCameras()).filter(c=>{const d=(c.label||"").toLowerCase();return!d.includes("virtual")&&!d.includes("screen")&&!d.includes("obs")&&!d.includes("capture")&&!d.includes("dshow")&&c.deviceId&&c.deviceId.length>0});let r,a="user";if(t.length>0){const c=t.find(d=>{const u=(d.label||"").toLowerCase();return u.includes("front")||u.includes("user")||u.includes("facing")&&u.includes("user")});r=c?c.deviceId:t[0].deviceId}const o=await M.createCameraVideoTrack({cameraId:r,encoderConfig:{width:1280,height:720,frameRate:30,bitrateMax:2e3}});m.current=o,await new Promise(c=>setTimeout(c,200));const l=o.getMediaStreamTrack()?.getSettings();if(l&&l.facingMode)a=l.facingMode,console.log("Initial camera facingMode detected:",a);else if(t.length>0){const d=((t.find(p=>p.deviceId===r)||t[0]).label||"").toLowerCase();a=d.includes("back")||d.includes("rear")||d.includes("environment")||d.includes("world")?"environment":"user",console.log("Initial camera facingMode from label:",a)}de(a);const i=(c=0)=>{if(y.current&&o&&o.enabled)try{const d=o.play(y.current);d&&typeof d.then=="function"?d.then(()=>{console.log("Local video playing successfully"),j("connected"),k(!1)}).catch(u=>{console.error("Error playing local video:",u),c<10&&o&&o.enabled?setTimeout(()=>i(c+1),200):console.error("Failed to play local video after retries")}):(console.log("Video play returned non-promise, assuming success"),j("connected"),k(!1))}catch(d){console.error("Error calling play on local video track:",d),c<10&&o&&o.enabled?setTimeout(()=>i(c+1),200):console.error("Failed to play local video after retries")}else c<20&&o&&setTimeout(()=>i(c+1),100)};i(),await I.current.publish([e,o]),g.current&&g.current.emit("participant-status",{liveClassId:h,isMuted:!1,isVideoEnabled:!0}),setTimeout(()=>{Ae()},2e3)}catch(e){throw console.error("Error creating local tracks:",e),e.message.includes("permission")?w("Camera/Microphone permission denied. Please allow access."):w("Failed to access camera/microphone"),e}},Ae=()=>{try{if(typeof MediaRecorder>"u"){console.error("[Recording] MediaRecorder is not supported in this browser"),w("Recording is not supported in this browser");return}if(!m.current||!x.current){console.error("[Recording] Video or audio tracks are not available"),w("Video or audio tracks are not available for recording");return}const e=m.current.getMediaStreamTrack(),s=x.current.getMediaStreamTrack();if(!e||!s){console.error("[Recording] Failed to get MediaStreamTracks"),w("Failed to get video or audio tracks");return}if(e.readyState!=="live"||s.readyState!=="live"){console.error("[Recording] Tracks are not live:",{video:e.readyState,audio:s.readyState}),w("Video or audio tracks are not live");return}const t=new MediaStream;if(t.addTrack(e),t.addTrack(s),console.log("[Recording] Stream created with tracks:",{videoTrack:{id:e.id,kind:e.kind,enabled:e.enabled,readyState:e.readyState},audioTrack:{id:s.id,kind:s.kind,enabled:s.enabled,readyState:s.readyState},streamTracks:t.getTracks().length}),t.getTracks().length===0){console.error("[Recording] Stream has no tracks"),w("Stream has no tracks for recording");return}let r="video/webm";MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?r="video/webm;codecs=vp9":MediaRecorder.isTypeSupported("video/webm")?r="video/webm":MediaRecorder.isTypeSupported("video/mp4")?r="video/mp4":console.warn("[Recording] No supported codec found, using default");const a={mimeType:r,videoBitsPerSecond:25e5};console.log("[Recording] Initializing MediaRecorder with:",a);try{b.current=new MediaRecorder(t,a),E.current=[],console.log("[Recording] MediaRecorder created successfully")}catch(o){console.error("[Recording] Failed to create MediaRecorder:",o);try{b.current=new MediaRecorder(t),E.current=[],console.log("[Recording] MediaRecorder created with default options")}catch(l){console.error("[Recording] Failed to create MediaRecorder with default options:",l),w("Failed to initialize recording: "+l.message);return}}b.current.ondataavailable=o=>{o.data&&o.data.size>0?(E.current.push(o.data),console.log("[Recording] Chunk received:",{size:o.data.size,totalChunks:E.current.length,totalSize:E.current.reduce((l,i)=>l+i.size,0)})):console.warn("[Recording] Empty or invalid chunk received")},b.current.onstop=()=>{console.log("[Recording] Recording stopped. Total chunks:",E.current.length)},b.current.onerror=o=>{console.error("[Recording Error]:",o.error),w("Recording error: "+o.error.message)};try{if(b.current.state!=="inactive"){console.warn("[Recording] MediaRecorder is not inactive. Current state:",b.current.state),w("Recording is already active or in an invalid state.");return}b.current.start(1e3),z(!0),console.log("[Recording] MediaRecorder.start() called"),setTimeout(()=>{if(!b.current){console.error("[Recording] MediaRecorder is null"),z(!1),w("Recording failed - MediaRecorder is null");return}b.current.state==="recording"?console.log("[Recording] ✅ Local recording started successfully",{state:b.current.state,mimeType:b.current.mimeType}):(console.error("[Recording] ❌ Recording failed to start. State:",b.current.state),z(!1),w("Recording failed to start. State: "+b.current.state))},300)}catch(o){console.error("[Recording] Error starting MediaRecorder:",o),z(!1),w("Failed to start recording: "+o.message)}}catch(e){console.error("[Start Recording Error]:",e),w("Failed to start recording: "+e.message)}},be=async()=>new Promise((e,s)=>{if(!b.current){console.warn("[Recording] MediaRecorder not initialized"),e(null);return}if(!se){console.warn("[Recording] Recording was not active"),e(null);return}if(b.current.state==="inactive"){console.warn("[Recording] MediaRecorder is already inactive"),e(null);return}try{b.current.onstop=async()=>{try{console.log("[Recording] MediaRecorder stopped. Processing chunks..."),console.log("[Recording] Total chunks:",E.current.length),await new Promise(c=>setTimeout(c,100));const t=E.current.reduce((c,d)=>c+(d?.size||0),0);if(console.log("[Recording] Total size:",t,"bytes",t>0?`(${(t/(1024*1024)).toFixed(2)} MB)`:""),E.current.length===0||t===0){console.error("[Recording] ❌ No recording chunks available - recording failed"),e(null);return}const r=new Blob(E.current,{type:b.current.mimeType||"video/webm"});console.log("[Recording] Recording blob created:",{size:r.size,type:r.type,sizeInMB:(r.size/(1024*1024)).toFixed(2),chunks:E.current.length});let a=r.type;r.type.includes("webm")?a="video/webm":r.type.includes("mp4")&&(a="video/mp4");const o=r.type.includes("webm")?"webm":"mp4",l=`recording_${h}_${Date.now()}.${o}`,i=new File([r],l,{type:a});console.log("[Recording] File created for upload:",{filename:l,size:i.size,type:i.type});try{console.log("[Recording] Starting upload...");const c=await P.uploadRecording(h,i);console.log("[Recording] Upload response received:",c),c.success?(console.log("[Recording] ✅ Recording uploaded successfully:",c.data.s3Url),e(c.data)):(console.error("[Recording] Upload failed:",c.message),s(new Error(c.message||"Upload failed")))}catch(c){console.error("[Recording] Upload error:",c),s(c)}}catch(t){console.error("[Recording] Error processing recording:",t),s(t)}},b.current.state==="recording"?(b.current.stop(),z(!1)):(console.warn("[Recording] MediaRecorder is not in recording state:",b.current.state),e(null))}catch(t){console.error("[Recording] Error stopping MediaRecorder:",t),z(!1),s(t)}}),Pe=async(e,s)=>{try{if(s==="video"&&!e.hasVideo){console.warn("[Agora] User does not have video stream available");return}if(s==="audio"&&!e.hasAudio){console.warn("[Agora] User does not have audio stream available");return}try{await I.current.subscribe(e,s)}catch(t){if(t.message&&t.message.includes("no such stream id")){console.warn("[Agora] Stream not available yet, will retry:",{userId:e.uid,mediaType:s,error:t.message}),setTimeout(async()=>{try{await I.current.subscribe(e,s)}catch(r){console.error("[Agora] Retry subscribe failed:",r)}},1e3);return}throw t}if(s==="video"){F.current[e.uid]=e,T();const t=(r=0)=>{const a=document.getElementById(`remote-video-${e.uid}`);if(a&&e.videoTrack)try{const o=e.videoTrack.play(a);o&&typeof o.catch=="function"&&o.catch(l=>{console.error("Error playing remote video:",l)})}catch(o){console.error("Error calling play on remote video track:",o)}else e.videoTrack&&r<10&&setTimeout(()=>t(r+1),100)};t()}if(s==="audio"&&e.audioTrack)try{const t=e.audioTrack.play();t&&typeof t.catch=="function"&&t.catch(r=>{console.error("Error playing remote audio:",r)})}catch(t){console.error("Error calling play on remote audio track:",t)}}catch(t){console.error("Error handling user published:",t)}},Ve=(e,s)=>{s==="video"&&(delete F.current[e.uid],T())},Le=e=>{delete F.current[e.uid],T()},Fe=(e,s)=>{if(console.log("Agora connection state:",e,"Previous:",s),e==="CONNECTING")j("connecting"),O==="connected"&&k(!0);else if(e==="CONNECTED"){if(j("connected"),k(!1),m.current&&y.current&&m.current.enabled)try{const t=m.current.play(y.current);t&&typeof t.catch=="function"&&t.catch(r=>{console.error("Error playing video after connection:",r)})}catch(t){console.error("Error calling play on video after connection:",t)}}else e==="DISCONNECTED"?(j("disconnected"),console.log("Agora client disconnected; waiting for explicit leave or internal reconnection")):e==="RECONNECTING"&&(j("connecting"),k(!0))},ze=async()=>{try{const e=await P.joinLiveClass(h);if(e.success&&e.data){const{agoraToken:s}=e.data;await I.current.renewToken(s)}}catch(e){console.error("Error renewing token:",e)}},Oe=async()=>{try{if(x.current&&I.current){const e=!_;if(e)await x.current.setVolume(0),await x.current.setEnabled(!1),console.log("Teacher audio track muted");else{console.log("Unmuting teacher audio track..."),await x.current.setVolume(100),await x.current.setEnabled(!0),await new Promise(t=>setTimeout(t,300));const s=x.current.enabled;if(console.log("Teacher audio track enabled:",s),await x.current.setVolume(100),!s){console.warn("Teacher audio track not enabled after unmute, attempting republish...");try{await I.current.unpublish([x.current]),await new Promise(t=>setTimeout(t,200)),await x.current.setVolume(100),await x.current.setEnabled(!0),await I.current.publish([x.current]),console.log("Teacher audio track republished successfully")}catch(t){console.error("Error republishing teacher audio track:",t)}}}Re(e),g.current&&g.current.emit("participant-status",{liveClassId:h,isMuted:e,isVideoEnabled:R})}}catch(e){console.error("Error toggling mute:",e)}},De=async()=>{try{if(m.current){const e=!R;if(e){if(await m.current.setEnabled(!0),le(!0),await new Promise(s=>setTimeout(s,200)),y.current&&m.current.enabled)try{const s=m.current.play(y.current);s&&typeof s.catch=="function"&&s.catch(t=>{console.error("Error playing video after enabling:",t)})}catch(s){console.error("Error playing video:",s)}}else{if(y.current&&m.current)try{m.current.stop()}catch(s){console.warn("Error stopping video track:",s)}await m.current.setEnabled(!1),le(!1)}g.current&&g.current.emit("participant-status",{liveClassId:h,isMuted:_,isVideoEnabled:e})}}catch(e){console.error("Error toggling video:",e)}},$e=async()=>{try{if(!m.current||!I.current)return;const s=(await M.getCameras()).filter(o=>{const l=(o.label||"").toLowerCase();return!l.includes("virtual")&&!l.includes("screen")&&!l.includes("obs")&&!l.includes("capture")&&!l.includes("dshow")&&o.deviceId&&o.deviceId.length>0});if(s.length===0){console.warn("No physical cameras found");return}const r=m.current.getMediaStreamTrack()?.getSettings()?.deviceId||m.current.getDeviceId?.();let a=s.find(o=>o.deviceId&&o.deviceId!==r);if(!a&&s.length>1)a=s.find(o=>o.deviceId!==r)||s[0];else if(!a&&s.length===1){console.warn("Only one camera available, cannot switch");return}if(a){console.log("[Camera Switch] Starting camera switch to:",a.label||a.deviceId);const o=m.current,l=o.enabled;try{await I.current.unpublish([o]),console.log("[Camera Switch] Old video track unpublished")}catch(u){console.warn("[Camera Switch] Error unpublishing old track:",u)}const i=await M.createCameraVideoTrack({cameraId:a.deviceId,encoderConfig:{width:1280,height:720,frameRate:30,bitrateMax:2e3}});await new Promise(u=>setTimeout(u,150));const c=i.getMediaStreamTrack()?.getSettings();let d=null;if(c&&c.facingMode)d=c.facingMode,console.log("[Camera Switch] Detected facingMode from track settings:",d);else{const u=(a.label||"").toLowerCase(),p=u.includes("back")||u.includes("rear")||u.includes("environment")||u.includes("world"),S=u.includes("front")||u.includes("user")||u.includes("facing")&&u.includes("user");d=p?"environment":S?"user":"environment",console.log("[Camera Switch] Detected facingMode from device label:",d,"Label:",u)}de(d),console.log("[Camera Switch] Switched camera to device:",a.label||a.deviceId,"Facing:",d),await i.setEnabled(l),m.current=i;try{await I.current.publish([i]),console.log("[Camera Switch] New video track published successfully")}catch(u){throw console.error("[Camera Switch] Error publishing new video track:",u),u}try{o.stop(),o.close(),console.log("[Camera Switch] Old video track stopped and closed")}catch(u){console.warn("[Camera Switch] Error closing old track:",u)}if(y.current&&i&&i.enabled)try{await i.play(y.current),console.log("[Camera Switch] New video track playing successfully"),setTimeout(()=>{const u=y.current?.querySelector("video")||(y.current?.tagName==="VIDEO"?y.current:null);u&&(d==="user"?u.style.transform="scaleX(-1)":u.style.transform="scaleX(1)",u.style.transition="transform 0.2s ease-in-out",console.log("[Camera Switch] Applied video transform:",d))},100)}catch(u){console.warn("[Camera Switch] Error playing new video track:",u),setTimeout(async()=>{if(y.current&&i&&i.enabled)try{await i.play(y.current),setTimeout(()=>{const p=y.current?.querySelector("video");p&&(p.style.transform=d==="user"?"scaleX(-1)":"scaleX(1)",p.style.transition="transform 0.2s ease-in-out")},100)}catch(p){console.error("[Camera Switch] Error replaying video on retry:",p)}},300)}g.current&&g.current.emit("participant-status",{liveClassId:h,isMuted:!x.current?.enabled,isVideoEnabled:i.enabled}),console.log("[Camera Switch] Camera switch completed successfully")}else console.warn("[Camera Switch] No alternative camera found to switch")}catch(e){console.error("[Camera Switch] Error switching camera:",e),w("Failed to switch camera. Please try again.")}},He=async e=>{try{const s=B.find(r=>(r.userId?._id?.toString()||r.userId?.toString())===e?.toString());let t=null;if(s&&s.agoraUid)t=s.agoraUid;else{const r=Object.values(F.current)[0];r&&(t=r.uid)}if(I.current&&t)try{await I.current.muteRemoteAudioStream(t,!0),console.log("Muted remote user audio via Agora, UID:",t)}catch(r){console.error("Error muting via Agora:",r)}g.current&&(g.current.emit("participant-mute",{liveClassId:h,targetUserId:e,muted:!0}),T())}catch(s){console.error("Error muting participant:",s)}},Be=async e=>{try{const s=B.find(r=>(r.userId?._id?.toString()||r.userId?.toString())===e?.toString());let t=null;if(s&&s.agoraUid)t=s.agoraUid;else{const r=Object.values(F.current)[0];r&&(t=r.uid)}if(I.current&&t)try{await I.current.muteRemoteAudioStream(t,!1),console.log("Unmuted remote user audio via Agora, UID:",t)}catch(r){console.error("Error unmuting via Agora:",r)}g.current&&(g.current.emit("participant-mute",{liveClassId:h,targetUserId:e,muted:!1}),T())}catch(s){console.error("Error unmuting participant:",s)}},Xe=async e=>{if(window.confirm("Are you sure you want to remove this student from the class?"))try{g.current&&(A(s=>s.filter(t=>(t.userId?._id?.toString()||t.userId?.toString()||t.userId)!==e?.toString())),g.current.emit("kick-student",{liveClassId:h,targetUserId:e}),setTimeout(()=>T(),1e3))}catch(s){console.error("Error kicking student:",s),T()}},we=async()=>{try{L>0&&(await P.markChatAsRead(h)).success&&(ee(0),$(s=>s.map(t=>{const r=re(),a=t.userId?._id?.toString()||t.userId?.toString()||t.userId;return r&&a&&r.toString()===a.toString()||t.readBy&&t.readBy.some(i=>i.userId?.toString()===r?.toString())?t:{...t,readBy:[...t.readBy||[],{userId:r,readAt:new Date}]}})))}catch(e){console.error("Error marking messages as read:",e)}},ve=async()=>{if(J.trim())try{if(!localStorage.getItem("dvision_teacher_token")){w("Session expired. Please log in again."),v("/teacher/login",{replace:!0});return}if(!g.current&&(console.error("Socket not initialized, re-initializing..."),ye(),await new Promise(r=>setTimeout(r,500)),!g.current||!g.current.connected)){alert("Connection not established. Please refresh the page.");return}if(!g.current.connected&&(console.error("Socket not connected, attempting to reconnect..."),g.current.connect(),await new Promise(r=>setTimeout(r,1e3)),!g.current.connected)){alert("Connection lost. Please refresh the page.");return}const s=J.trim();console.log("Teacher sending chat message:",s),console.log("Socket connected:",g.current.connected),console.log("Socket ID:",g.current.id);const t={userId:C?.teacherId?._id||C?.teacherId,userType:"Teacher",userName:"You",message:s,timestamp:new Date,_id:`temp-${Date.now()}`};$(r=>[...r,t]),ge(""),g.current.emit("chat-message",{liveClassId:h,message:s}),console.log("Chat message emitted to socket"),setTimeout(()=>{te.current?.scrollIntoView({behavior:"smooth"})},100)}catch(e){console.error("Error sending message:",e),alert("Failed to send message. Please try again.")}},qe=async()=>{if(window.confirm("Are you sure you want to end this class? All students will be disconnected."))try{if(C?.status==="ended"){console.log("[End Class] Class is already ended, cleaning up..."),D(),v("/teacher/live-classes");return}if(se&&b.current){console.log("[End Class] Stopping recording before ending class...");try{be().then(e=>{e&&e.s3Url?console.log("[End Class] ✅ Recording uploaded successfully:",e.s3Url):console.warn("[End Class] Recording stopped but upload result is empty")}).catch(e=>{console.error("[End Class] Error stopping/uploading recording:",e)})}catch(e){console.error("[End Class] Error stopping recording:",e)}}await P.endLiveClass(h),D(),v("/teacher/live-classes")}catch(e){e.message&&e.message.includes("already ended")?(console.log("[End Class] Class was already ended, cleaning up..."),D(),v("/teacher/live-classes")):alert(e.message||"Failed to end class")}},D=async()=>{try{if(se&&b.current&&b.current.state==="recording")try{console.log("[Cleanup] Stopping recording..."),await be()}catch(e){console.error("[Cleanup] Error stopping recording:",e)}if(g.current&&(g.current.removeAllListeners(),g.current.emit("leave-live-class",{liveClassId:h}),g.current.disconnect(),g.current=null),x.current&&(x.current.stop(),x.current.close(),x.current=null),m.current&&(m.current.stop(),m.current.close(),m.current=null),I.current){try{await I.current.leave()}catch(e){console.warn("Error leaving Agora channel:",e)}I.current=null}F.current={},j("disconnected"),k(!1)}catch(e){console.error("Error during cleanup:",e)}};if(Ce)return n.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),n.jsx("p",{children:"Joining class..."})]})});if(ce&&!C)return n.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:n.jsxs("div",{className:"text-white text-center",children:[n.jsx("p",{className:"mb-4",children:ce}),n.jsx("button",{onClick:()=>v("/teacher/live-classes"),className:"bg-blue-600 px-4 py-2 rounded-lg",children:"Go Back"})]})});const B=je.filter(e=>e.userType==="Student"&&!e.leftAt),X=fe.length;return n.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[he&&n.jsxs("header",{className:"bg-gray-800 px-4 py-3 flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("button",{onClick:()=>{D(),v("/teacher/live-classes")},className:"p-2 hover:bg-gray-700 rounded-lg",children:n.jsx(Ze,{className:"text-xl"})}),n.jsxs("div",{children:[n.jsx("h1",{className:"font-bold text-lg",children:C?.title||"Live Class"}),n.jsxs("p",{className:"text-sm text-gray-400",children:[C?.subjectId?.name," • ",B.length," students",ue&&n.jsx("span",{className:"text-yellow-500 ml-2",children:"• Reconnecting..."})]})]})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[X>0&&n.jsxs("div",{className:"bg-yellow-500 text-black px-3 py-1 rounded-lg font-bold flex items-center gap-2",children:[n.jsx(Se,{className:"text-lg"})," ",X," Hand",X>1?"s":""," Raised"]}),n.jsxs("button",{onClick:()=>{G?(W(!1),setTimeout(()=>K(!0),100)):K(!Q)},className:"p-2 hover:bg-gray-700 rounded-lg relative",title:"Participants",children:[n.jsx(Je,{className:"text-xl"}),X>0&&n.jsx("span",{className:"absolute top-0 right-0 bg-yellow-500 text-xs rounded-full w-5 h-5 flex items-center justify-center text-black font-bold",children:X})]}),n.jsxs("button",{onClick:()=>{const e=!G;Q?(K(!1),setTimeout(()=>{W(!0),L>0&&we()},100)):(W(e),e&&L>0&&we())},className:"p-2 hover:bg-gray-700 rounded-lg relative",children:[n.jsx(Qe,{className:"text-xl"}),L>0&&n.jsx("span",{className:"absolute top-0 right-0 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center",children:L>99?"99+":L})]})]})]}),n.jsxs("div",{className:"flex-1 relative overflow-hidden",onClick:ne,onMouseMove:ne,onTouchStart:ne,children:[n.jsxs("div",{className:"absolute inset-0 bg-black flex items-center justify-center overflow-hidden",children:[n.jsx("div",{ref:y,className:"w-full h-full flex items-center justify-center",style:{position:"relative",width:"100%",height:"100%"}}),!R&&n.jsxs("div",{className:"absolute inset-0 bg-gray-900 flex flex-col items-center justify-center z-10",children:[n.jsx(xe,{className:"text-6xl text-gray-500 mb-4"}),n.jsx("span",{className:"text-lg text-gray-400",children:"Camera Off"})]}),(ue||O==="connecting")&&n.jsx("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center z-20",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),n.jsx("p",{className:"text-white",children:"Connecting..."})]})}),n.jsx("div",{className:"absolute bottom-4 left-4 bg-black/70 px-3 py-2 rounded-lg z-10",children:n.jsxs("p",{className:"text-sm font-semibold text-white",children:["You ",_&&"(Muted)"]})})]}),Q&&n.jsxs("div",{className:"absolute top-0 right-0 w-80 h-full bg-gray-800 border-l border-gray-700 flex flex-col z-30 shadow-2xl",children:[n.jsxs("div",{className:"p-4 border-b border-gray-700 flex items-center justify-between",children:[n.jsxs("h2",{className:"font-bold",children:["Participants (",B.length+1,")"]}),n.jsx("button",{onClick:()=>K(!1),className:"p-1 hover:bg-gray-700 rounded",children:n.jsx(ae,{})})]}),n.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-2",children:[n.jsx("div",{className:"bg-gray-700 p-3 rounded-lg flex items-center justify-between",children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold",children:"T"}),n.jsxs("div",{children:[n.jsx("p",{className:"text-sm font-semibold",children:"You (Teacher)"}),n.jsxs("p",{className:"text-xs text-gray-400",children:[_?"Muted":"Unmuted"," • ",R?"Video On":"Video Off"]})]})]})}),B.map(e=>{const s=e.userId?._id?.toString()||e.userId?.toString(),t=fe.find(r=>r.userId?.toString()===s);return n.jsxs("div",{className:`bg-gray-700 p-3 rounded-lg flex items-center justify-between ${t?"ring-2 ring-yellow-500":""}`,children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[n.jsx("div",{className:"w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-sm font-bold",children:e.userId?.name?.[0]?.toUpperCase()||"S"}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"text-sm font-semibold truncate",children:e.userId?.name||e.userName||"Student"}),n.jsxs("p",{className:"text-xs text-gray-400",children:[e.isMuted?"Muted":"Unmuted"," • ",e.isVideoEnabled?"Video On":"Video Off"]})]})]}),n.jsxs("div",{className:"flex items-center gap-1",children:[t&&n.jsx("div",{className:"bg-yellow-500 px-2 py-1 rounded text-xs font-bold text-black flex items-center",children:n.jsx(Se,{className:"text-sm"})}),n.jsx("button",{onClick:()=>e.isMuted?Be(e.userId?._id||e.userId):He(e.userId?._id||e.userId),className:"p-1 hover:bg-gray-600 rounded",title:e.isMuted?"Unmute":"Mute",children:e.isMuted?n.jsx(er,{}):n.jsx(rr,{})}),n.jsx("button",{onClick:()=>Xe(e.userId?._id||e.userId),className:"p-1 hover:bg-red-600 rounded text-red-400",title:"Remove",children:n.jsx(ae,{})})]})]},e._id||e.userId?._id)})]})]}),G&&n.jsxs("div",{className:"absolute top-0 right-0 w-80 h-full bg-gray-800 border-l border-gray-700 flex flex-col z-30 shadow-2xl",children:[n.jsxs("div",{className:"p-4 border-b border-gray-700 flex items-center justify-between",children:[n.jsx("h2",{className:"font-bold",children:"Chat"}),n.jsx("button",{onClick:()=>W(!1),className:"p-1 hover:bg-gray-700 rounded",children:n.jsx(ae,{})})]}),n.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[Ee.map((e,s)=>{const t=C?.teacherId?._id?.toString()||C?.teacherId?.toString(),r=e.userId?._id?.toString()||e.userId?.toString()||e.userId,a=t===r;return n.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:n.jsxs("div",{className:`max-w-[75%] p-2 rounded-lg ${a?"bg-blue-600 text-white":"bg-gray-700 text-white"}`,children:[!a&&n.jsx("p",{className:"text-xs opacity-80 mb-1",children:e.userName}),n.jsx("p",{className:"text-sm",children:e.message})]})},e._id||`${e.userId}-${e.timestamp}-${s}`)}),n.jsx("div",{ref:te})]}),n.jsxs("div",{className:"p-4 border-t border-gray-700 flex gap-2",children:[n.jsx("input",{type:"text",value:J,onChange:e=>ge(e.target.value),onKeyPress:e=>e.key==="Enter"&&ve(),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.jsx("button",{onClick:ve,className:"bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700",children:n.jsx(tr,{})})]})]})]}),he&&n.jsxs("div",{className:"bg-gray-800 px-4 py-3 flex items-center justify-center gap-4",children:[n.jsx("button",{onClick:Oe,className:`p-3 rounded-full ${_?"bg-red-600":"bg-gray-700"} hover:bg-opacity-80`,title:_?"Unmute":"Mute",children:_?n.jsx(sr,{className:"text-xl"}):n.jsx(nr,{className:"text-xl"})}),n.jsx("button",{onClick:De,className:`p-3 rounded-full ${R?"bg-gray-700":"bg-red-600"} hover:bg-opacity-80`,title:R?"Turn off camera":"Turn on camera",children:R?n.jsx(or,{className:"text-xl"}):n.jsx(xe,{className:"text-xl"})}),n.jsx("button",{onClick:$e,className:"p-3 rounded-full bg-gray-700 hover:bg-opacity-80",title:"Switch camera",children:n.jsx(cr,{className:"text-xl"})}),n.jsx("button",{onClick:qe,className:"p-3 rounded-full bg-red-600 hover:bg-red-700",title:"End class",children:n.jsx(ar,{className:"text-xl rotate-135"})})]})]})};export{mr as default};
