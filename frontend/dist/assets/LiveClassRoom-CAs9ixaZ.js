import{u as Te,q as Ue,r as l,j as s,c as _e,T as Ae,U as Re,V as Me,W as Oe,X as Pe,Y as De,p as H}from"./index-BPKQ2keO.js";import{l as Le,A as U,P as Ve}from"./index-DXNgcvxb.js";const $e=()=>{{const d="http://localhost:5000/api".replace(/\/$/,"");return console.log("[Student Socket] Using VITE_API_BASE_URL from env:",d),d}},de=$e(),Fe=()=>{try{const y="http://localhost:5000/";if(y){const E=y.replace(/\/$/,"");return console.log("[Student Socket] Using VITE_SOCKET_URL:",E),E}let d=de;if(d=d.replace(/\/api\/?$/,""),d=d.replace(/\/$/,""),d.startsWith("http://")||d.startsWith("https://")){const E=new URL(d),_=`${E.protocol}//${E.host}`;return console.log("[Student Socket] Socket URL determined:",_,"from API URL:",de),_}const m="http://localhost:5000";return console.log("[Student Socket] Using default socket URL:",m),m}catch(y){return console.error("[Student Socket] Error parsing URL, using default:",y),"http://localhost:5000"}},ue=Fe();console.log("[Student Socket] Final SOCKET_URL:",ue);const Be=()=>{const y=Te(),{id:d}=Ue(),[m,E]=l.useState(null),[_,Q]=l.useState(!0),[Z,x]=l.useState(""),[A,R]=l.useState(!1),[z,ee]=l.useState(!1),[ge,he]=l.useState(window.innerWidth>window.innerHeight?"landscape":"portrait"),[B,p]=l.useState(!1),[fe,te]=l.useState(!1),[pe,me]=l.useState(!1),[re,I]=l.useState(!1),[M,V]=l.useState([]),W=l.useRef(null),[J,ne]=l.useState(""),[b,se]=l.useState(!1),[K,O]=l.useState(0),q=()=>{const e=localStorage.getItem("dvision_token");if(e)try{return JSON.parse(atob(e.split(".")[1])).id}catch(r){console.error("Error parsing token:",r)}return null},$=e=>{const r=q();return r?e.filter(t=>(t.userId?._id?.toString()||t.userId?.toString()||t.userId)===r?.toString()?!1:!(t.readBy&&t.readBy.some(a=>a.userId?.toString()===r?.toString()))).length:0},u=l.useRef(null),g=l.useRef(null),k=l.useRef({}),S=l.useRef(null),i=l.useRef(null),[Y,C]=l.useState("disconnected"),[w,P]=l.useState(!1),[oe,ae]=l.useState(!0),D=l.useRef(null),F=l.useCallback(()=>{D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{ae(!1)},2e3)},[]),X=l.useCallback(()=>{ae(!0),F()},[F]);l.useEffect(()=>{let e=!0;return(async()=>{await G(),e&&await ye()})(),F(),()=>{e=!1,G(),D.current&&clearTimeout(D.current)}},[d,F]),l.useEffect(()=>{const r=setInterval(()=>{u.current&&u.current.connectionState==="CONNECTED"&&i.current&&i.current.connected&&Y==="connected"&&B&&(console.log("[Connection Check] Clearing false reconnecting state - both connections are stable"),p(!1))},5e3);return()=>clearInterval(r)},[B,Y]),l.useEffect(()=>{const e=Object.values(k.current);if(e.length>0&&S.current){const r=e[0];if(r.videoTrack&&S.current){console.log("Ensuring teacher video is played, UID:",r.uid);try{const t=r.videoTrack.play(S.current);t&&typeof t.catch=="function"&&t.catch(o=>{console.error("Error playing teacher video in useEffect:",o)})}catch(t){console.error("Error calling play on teacher video in useEffect:",t)}}}},[Y]),l.useEffect(()=>{const e=()=>{const r=window.innerWidth>window.innerHeight?"landscape":"portrait";he(r)};return window.addEventListener("resize",e),window.addEventListener("orientationchange",e),e(),()=>{window.removeEventListener("resize",e),window.removeEventListener("orientationchange",e)}},[]),l.useEffect(()=>{const e=()=>{if(S.current){const o=S.current.querySelector("video");o&&(o.style.objectFit="contain",o.style.width="100%",o.style.height="100%",o.style.maxWidth="100%",o.style.maxHeight="100%",o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.backgroundColor="black")}};e();const r=setTimeout(e,200),t=setInterval(e,1e3);return()=>{clearTimeout(r),clearInterval(t)}},[ge,re]);const ce=l.useCallback(()=>{i.current&&(i.current.removeAllListeners(),i.current.disconnect(),i.current=null);const e=localStorage.getItem("dvision_token");if(!e){console.error("No auth token found"),x("Session expired. Please log in again."),y("/login",{replace:!0});return}const r=Le(ue,{auth:{token:e},transports:["websocket","polling"],reconnection:!0,reconnectionDelay:1e3,reconnectionAttempts:5,path:"/socket.io/",autoConnect:!0});return r.on("connect",()=>{console.log("Student socket connected"),C("connected"),p(!1),P(!0),r.emit("join-live-class",{liveClassId:d}),console.log("Student joined live class room:",d)}),r.on("disconnect",t=>{console.log("Socket disconnected, reason:",t),C("disconnected"),p(!!(w&&t!=="io client disconnect"))}),r.on("connect_error",t=>{console.error("Socket connection error:",t),p(!!w)}),r.on("reconnect",t=>{console.log("Student socket reconnected after",t,"attempts"),p(!1),P(!0),r.emit("join-live-class",{liveClassId:d}),console.log("Student rejoined live class room:",d)}),r.on("reconnect_attempt",t=>{console.log("Socket reconnect attempt:",t),w&&p(!0)}),r.on("reconnect_error",t=>{console.error("Socket reconnect error:",t),w&&p(!0)}),r.on("reconnect_failed",()=>{console.error("Socket reconnect failed"),p(!1)}),r.on("chat-message",t=>{console.log("Student received chat message:",t),console.log("Message details:",{userId:t.userId,userName:t.userName,userType:t.userType,message:t.message,messageId:t._id}),V(o=>{const n=o.filter(h=>{if(h._id&&h._id.toString().startsWith("temp-")){const j=h.userId?._id?.toString()||h.userId?.toString()||h.userId,T=t.userId?._id?.toString()||t.userId?.toString()||t.userId;return!(j===T&&h.message===t.message)}return!0});if(n.some(h=>{if(h._id&&t._id&&!h._id.toString().startsWith("temp-"))return h._id.toString()===t._id.toString();const j=h.userId?._id?.toString()||h.userId?.toString()||h.userId,T=t.userId?._id?.toString()||t.userId?.toString()||t.userId;return j===T&&h.message===t.message&&Math.abs(new Date(h.timestamp)-new Date(t.timestamp))<1e3}))return console.log("Duplicate message ignored"),n;const a=[...n,t],f=q(),v=t.userId?._id?.toString()||t.userId?.toString()||t.userId,L=f&&v&&f.toString()===v.toString();return!b&&!L&&O(h=>h+1),setTimeout(()=>{W.current?.scrollIntoView({behavior:"smooth"})},100),a})}),r.on("user-joined",({userName:t,userRole:o})=>{console.log(`User joined: ${t} (${o})`)}),r.on("user-left",({userName:t})=>{console.log(`User left: ${t}`)}),r.on("class-ended",({liveClassId:t})=>{console.log("Class ended event received:",t),t===d&&me(!0)}),r.on("hand-raise-confirmed",({hasRaisedHand:t})=>{ee(t)}),r.on("student-kicked",({userId:t})=>{const o=localStorage.getItem("dvision_token");let n=null;if(o)try{n=JSON.parse(atob(o.split(".")[1])).id}catch(c){console.error("Error parsing token:",c)}if(m){const c=m.participants?.find(a=>a.userId?._id?.toString()===t?.toString()||a.userId?.toString()===t?.toString());c&&(n=c.userId?._id||c.userId)}t?.toString()===n?.toString()&&(te(!0),setTimeout(()=>{G(),y("/live-classes")},3e3))}),r.on("participant-muted",async({userId:t,isMuted:o})=>{const n=localStorage.getItem("dvision_token");let c=null;if(n)try{c=JSON.parse(atob(n.split(".")[1])).id}catch(a){console.error("Error parsing token:",a)}if(t?.toString()===c?.toString()&&(console.log("Teacher muted/unmuted student:",o),R(o),u.current)){if(o){if(console.log("Muting student audio by teacher..."),g.current){try{await u.current.unpublish([g.current])}catch(a){console.warn("Error unpublishing audio track:",a)}try{await g.current.setEnabled(!1),await g.current.setVolume(0)}catch(a){console.warn("Error disabling audio track:",a)}}console.log("Student audio muted by teacher")}else{console.log("Unmuting student audio by teacher...");try{if(g.current){try{await u.current.unpublish([g.current])}catch(f){console.warn("Error unpublishing old audio track:",f)}try{g.current.stop(),g.current.close()}catch(f){console.warn("Error closing old audio track:",f)}g.current=null}const a=await U.createMicrophoneAudioTrack({encoderConfig:"speech_standard",AEC:!0,ANS:!0,AGC:!0});await a.setVolume(100),g.current=a,await new Promise(f=>setTimeout(f,200)),await u.current.publish([a]),console.log("Audio track recreated and published successfully after teacher unmute")}catch(a){console.error("Error recreating audio track after teacher unmute:",a)}}i.current&&i.current.emit("participant-status",{liveClassId:d,isMuted:o,isVideoEnabled:!1})}}),r.on("screen-share-status",({isSharing:t})=>{console.log(`Screen share ${t?"started":"stopped"}`)}),r.on("error",({message:t})=>{console.error("Socket error:",t),(t.includes("kicked")||t.includes("removed"))&&te(!0)}),i.current=r,r.connected&&(console.log("Student socket already connected, joining room"),r.emit("join-live-class",{liveClassId:d})),r},[d,y]),ye=async()=>{try{Q(!0),x(""),C("connecting"),p(!1),P(!1);const e=await H.joinLiveClass(d);if(e.success&&e.data){const{liveClass:r,agoraToken:t,agoraAppId:o,agoraChannelName:n,agoraUid:c,unreadMessageCount:a}=e.data;if(r.status!=="live"){x("Class is not live yet");return}E(r);const v=(r.chatMessages||[]).filter((h,j,T)=>{if(h._id)return T.findIndex(N=>N._id?.toString()===h._id.toString())===j;const je=h.userId?._id?.toString()||h.userId?.toString()||h.userId;return T.findIndex(N=>(N.userId?._id?.toString()||N.userId?.toString()||N.userId)===je&&N.message===h.message&&N.timestamp===h.timestamp)===j});V(v);const L=a!==void 0?a:$(v);O(L),ce(),await ve(o,t,n,c)}else x("Failed to join class")}catch(e){console.error("Error initializing class:",e),x(e.message||"Failed to join class")}finally{Q(!1)}},ve=async(e,r,t,o)=>{try{if(u.current){try{await u.current.leave()}catch(a){console.warn("Error leaving existing client:",a)}u.current=null}const n=U.createClient({mode:"rtc",codec:"vp8",enableAudio:!0,enableVideo:!1});u.current=n,await U.setParameter("AUDIO_AINS_AGGRESSIVE","high"),await U.setParameter("AUDIO_AINS_STRENGTH","high"),n.on("user-published",be),n.on("user-unpublished",ke),n.on("user-left",Se),n.on("connection-state-change",we),n.on("token-privilege-will-expire",Ce),await n.join(e,t,r,o),C("connected"),P(!0),p(!1),i.current&&i.current.connected&&p(!1);const c=n.remoteUsers;console.log("Existing remote users on join:",c.length);for(const a of c){if(console.log("Remote user:",a.uid,"hasVideo:",a.hasVideo,"hasAudio:",a.hasAudio),a.hasVideo&&(await n.subscribe(a,"video"),k.current[a.uid]=a,I(!0),S.current&&a.videoTrack)){console.log("Playing existing teacher video, UID:",a.uid);try{const f=a.videoTrack.play(S.current);f&&typeof f.then=="function"?f.then(()=>{console.log("Existing teacher video playing successfully")}).catch(v=>{console.error("Error playing existing teacher video:",v)}):console.log("Video play returned non-promise, assuming success")}catch(f){console.error("Error calling play on existing teacher video:",f)}}if(a.hasAudio&&(await n.subscribe(a,"audio"),a.audioTrack))try{const f=a.audioTrack.play();f&&typeof f.catch=="function"&&f.catch(v=>{console.error("Error playing existing teacher audio:",v)})}catch(f){console.error("Error calling play on existing teacher audio:",f)}}await xe()}catch(n){throw console.error("Error initializing Agora:",n),n.message.includes("permission")?x("Camera/Microphone permission denied. Please allow access."):x("Failed to initialize video/audio"),n}},xe=async()=>{try{const e=await U.createMicrophoneAudioTrack({encoderConfig:"speech_standard",AEC:!0,ANS:!0,AGC:!0});g.current=e,await e.setVolume(100),await u.current.publish([e]),i.current&&i.current.emit("participant-status",{liveClassId:d,isMuted:!1,isVideoEnabled:!1})}catch(e){throw console.error("Error creating local tracks:",e),e.message.includes("permission")?x("Camera/Microphone permission denied. Please allow access."):x("Failed to access camera/microphone"),e}},be=async(e,r)=>{try{if(console.log("User published:",e.uid,"MediaType:",r),!u.current){console.warn("Ignoring user-published event because Agora client is null");return}const t=u.current.connectionState;if(t&&t!=="CONNECTED"){console.warn("Ignoring user-published event because Agora client is not connected",{agoraState:t});return}if(await u.current.subscribe(e,r),r==="video"){k.current[e.uid]=e,console.log("Remote user video track:",e.videoTrack?"exists":"missing"),I(!0);const o=(n=0)=>{const c=S.current;if(console.log("Attempting to play video, container:",c?"exists":"missing","retry:",n),c&&e.videoTrack){console.log("Playing teacher video in container, UID:",e.uid);try{const a=e.videoTrack.play(c);a&&typeof a.then=="function"?a.then(()=>{console.log("Teacher video playing successfully"),I(!0)}).catch(f=>{console.error("Error playing teacher video:",f),n<5&&setTimeout(()=>o(n+1),200)}):(console.log("Video play returned non-promise, assuming success"),I(!0))}catch(a){console.error("Error calling play on video track:",a),n<5&&setTimeout(()=>o(n+1),200)}}else e.videoTrack&&n<20?setTimeout(()=>o(n+1),200):(console.warn("Could not play video: container or track missing after retries"),I(!0))};o()}if(r==="audio"&&e.audioTrack)try{const o=e.audioTrack.play();o&&typeof o.catch=="function"&&o.catch(n=>{console.error("Error playing teacher audio:",n)}),console.log("Teacher audio playing")}catch(o){console.error("Error calling play on audio track:",o)}}catch(t){console.error("Error handling user published:",t)}},ke=(e,r)=>{r==="video"&&(e.videoTrack&&e.videoTrack.stop(),delete k.current[e.uid],Object.keys(k.current).length===0&&I(!1))},Se=e=>{if(console.log("User left Agora channel:",e.uid),e.videoTrack)try{e.videoTrack.stop()}catch(r){console.warn("Error stopping video track:",r)}if(e.audioTrack)try{e.audioTrack.stop()}catch(r){console.warn("Error stopping audio track:",r)}delete k.current[e.uid],console.log("Remaining remote users:",Object.keys(k.current).length),Object.keys(k.current).length===0&&I(!1)},we=(e,r)=>{console.log("Connection state:",e,"Previous:",r,"Was connected:",w),e==="CONNECTING"?(p(!!(w&&(r==="CONNECTED"||r==="RECONNECTING"||r==="DISCONNECTED"))),C("connecting")):e==="CONNECTED"?(p(!1),C("connected"),P(!0),i.current&&i.current.connected&&p(!1)):e==="DISCONNECTED"?(p(!!(w&&(r==="CONNECTED"||r==="CONNECTING"))),C("disconnected"),w&&u.current&&m&&setTimeout(async()=>{try{const t=await H.joinLiveClass(d);if(t.success&&t.data){const{agoraToken:o,agoraAppId:n,agoraChannelName:c,agoraUid:a}=t.data;await u.current.leave(),await u.current.join(n,c,o,a)}}catch(t){console.error("Error reconnecting:",t)}},2e3)):e==="RECONNECTING"&&(p(!!w),C("connecting"))},Ce=async()=>{try{const e=await H.joinLiveClass(d);if(e.success&&e.data){const{agoraToken:r}=e.data;await u.current.renewToken(r)}}catch(e){console.error("Error renewing token:",e)}},Ee=async()=>{try{if(!u.current){console.warn("Cannot toggle mute: Agora client not initialized");return}const e=u.current.connectionState;if(e!=="CONNECTED"&&e!=="CONNECTING"){console.warn("Cannot toggle mute: Client not connected. State:",e);return}const r=!A;if(R(r),r){if(console.log("Muting student audio track..."),g.current){try{u.current&&e==="CONNECTED"&&await u.current.unpublish([g.current])}catch(t){console.warn("Error unpublishing audio track:",t)}try{g.current&&(await g.current.setEnabled(!1),await g.current.setVolume(0))}catch(t){console.warn("Error disabling audio track:",t)}}console.log("Student audio track muted")}else{console.log("Unmuting student audio track...");try{if(g.current){try{u.current&&e==="CONNECTED"&&await u.current.unpublish([g.current])}catch(o){console.warn("Error unpublishing old audio track:",o)}try{g.current&&(g.current.stop(),g.current.close())}catch(o){console.warn("Error closing old audio track:",o)}g.current=null}const t=await U.createMicrophoneAudioTrack({encoderConfig:"speech_standard",AEC:!0,ANS:!0,AGC:!0});await t.setVolume(100),g.current=t,await new Promise(o=>setTimeout(o,200)),u.current&&u.current.connectionState==="CONNECTED"?(await u.current.publish([t]),console.log("Audio track recreated and published successfully after unmute")):(console.warn("Cannot publish audio track: Client not connected"),R(!0))}catch(t){console.error("Error recreating audio track:",t),R(!0)}}i.current&&i.current.connected&&i.current.emit("participant-status",{liveClassId:d,isMuted:r,isVideoEnabled:!1})}catch(e){console.error("Error toggling mute:",e),R(A)}},Ie=async()=>{try{(await H.markChatAsRead(d)).success&&V(r=>{const t=r.map(n=>{const c=q(),a=n.userId?._id?.toString()||n.userId?.toString()||n.userId;return c&&a&&c.toString()===a.toString()||n.readBy&&n.readBy.some(L=>L.userId?.toString()===c?.toString())?n:{...n,readBy:[...n.readBy||[],{userId:c,readAt:new Date}]}}),o=$(t);return O(o),t})}catch(e){console.error("Error marking messages as read:",e)}};l.useEffect(()=>{if(b)Ie();else{const e=$(M);O(e)}},[b]),l.useEffect(()=>{if(!b&&M.length>0){const e=$(M);O(e)}},[M,b]);const Ne=async()=>{try{if(i.current&&i.current.connected){const e=!z;console.log("Student emitting hand-raise:",{liveClassId:d,raised:e}),i.current.emit("hand-raise",{liveClassId:d,raised:e}),ee(e)}else console.error("Socket not connected, cannot raise hand"),alert("Connection lost. Please refresh the page.")}catch(e){console.error("Error toggling hand raise:",e)}},ie=async()=>{if(J.trim())try{if(!i.current&&(console.error("Socket not initialized, re-initializing..."),ce(),await new Promise(n=>setTimeout(n,500)),!i.current||!i.current.connected)){alert("Connection not established. Please refresh the page.");return}if(!i.current.connected&&(console.error("Socket not connected, attempting to reconnect..."),i.current.connect(),await new Promise(n=>setTimeout(n,1e3)),!i.current.connected)){alert("Connection lost. Please refresh the page.");return}const e=J.trim();console.log("Student sending chat message:",e),console.log("Socket connected:",i.current.connected),console.log("Socket ID:",i.current.id);const r=localStorage.getItem("dvision_token");let t=null;if(r)try{t=JSON.parse(atob(r.split(".")[1])).id}catch(n){console.error("Error parsing token:",n)}const o={userId:t||m?.participants?.find(n=>n.userType==="Student")?.userId?._id||m?.participants?.find(n=>n.userType==="Student")?.userId,userType:"Student",userName:"You",message:e,timestamp:new Date,_id:`temp-${Date.now()}`};V(n=>[...n,o]),ne(""),i.current.emit("chat-message",{liveClassId:d,message:e}),console.log("Chat message emitted to socket"),setTimeout(()=>{W.current?.scrollIntoView({behavior:"smooth"})},100)}catch(e){console.error("Error sending message:",e),alert("Failed to send message. Please try again.")}},le=async()=>{G(),y("/live-classes")},G=async()=>{try{if(i.current&&(i.current.removeAllListeners(),i.current.emit("leave-live-class",{liveClassId:d}),i.current.disconnect(),i.current=null),g.current&&(g.current.stop(),g.current.close(),g.current=null),u.current){try{await u.current.leave()}catch(e){console.warn("Error leaving Agora channel:",e)}u.current=null}k.current={}}catch(e){console.error("Error during cleanup:",e)}};return _?s.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:s.jsxs("div",{className:"text-white text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),s.jsx("p",{children:"Joining class..."})]})}):fe?s.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:s.jsxs("div",{className:"text-white text-center",children:[s.jsx("div",{className:"text-6xl mb-4",children:"ðŸš«"}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"You have been removed from the class"}),s.jsx("p",{className:"text-gray-400",children:"Redirecting..."})]})}):pe?s.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:s.jsxs("div",{className:"text-white text-center",children:[s.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“š"}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Class has ended"}),s.jsx("button",{onClick:()=>y("/live-classes"),className:"mt-4 bg-blue-600 px-6 py-2 rounded-lg hover:bg-blue-700",children:"Go Back"})]})}):Z&&!m?s.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:s.jsxs("div",{className:"text-white text-center",children:[s.jsx("p",{className:"mb-4",children:Z}),s.jsx("button",{onClick:()=>y("/live-classes"),className:"bg-blue-600 px-4 py-2 rounded-lg",children:"Go Back"})]})}):s.jsxs("div",{className:"min-h-screen bg-gray-900 text-white flex flex-col",children:[oe&&s.jsx("header",{className:"bg-gray-800 px-4 py-3 flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("button",{onClick:le,className:"p-2 hover:bg-gray-700 rounded-lg",children:s.jsx(_e,{className:"text-xl"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"font-bold text-lg",children:m?.title||"Live Class"}),s.jsxs("p",{className:"text-sm text-gray-400",children:[m?.subjectId?.name,B&&s.jsx("span",{className:"text-yellow-500 ml-2",children:"â€¢ Reconnecting..."})]})]})]})}),s.jsxs("div",{className:"flex-1 flex relative overflow-hidden",onClick:X,onMouseMove:X,onTouchStart:X,children:[s.jsxs("div",{className:"flex-1 relative bg-black flex items-center justify-center overflow-hidden",children:[s.jsx("div",{id:"teacher-video-container",ref:S,className:"w-full h-full flex items-center justify-center",style:{position:"relative",width:"100%",height:"100%"}}),!re&&!_&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"}),s.jsx("p",{className:"text-gray-400",children:"Waiting for teacher video..."})]})})]}),b&&s.jsxs("div",{className:"w-80 bg-gray-800 border-l border-gray-700 flex flex-col",children:[s.jsxs("div",{className:"p-4 border-b border-gray-700 flex items-center justify-between",children:[s.jsx("h2",{className:"font-bold",children:"Chat"}),s.jsx("button",{onClick:()=>se(!1),className:"p-1 hover:bg-gray-700 rounded",children:s.jsx(Ae,{})})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[M.map((e,r)=>{let t=null;try{const c=localStorage.getItem("dvision_token");c&&(t=JSON.parse(atob(c.split(".")[1])).id)}catch(c){console.error("Error parsing token:",c)}if(!t&&m?.participants){const c=m.participants.find(a=>a.userType==="Student");c&&(t=c.userId?._id?.toString()||c.userId?.toString()||c.userId)}const o=e.userId?._id?.toString()||e.userId?.toString()||e.userId,n=t&&o&&t.toString()===o.toString();return s.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[75%] p-2 rounded-lg ${n?"bg-blue-600 text-white":"bg-gray-700 text-white"}`,children:[!n&&s.jsx("p",{className:"text-xs opacity-80 mb-1",children:e.userName}),s.jsx("p",{className:"text-sm",children:e.message})]})},e._id||`${e.userId}-${e.timestamp}-${r}`)}),s.jsx("div",{ref:W})]}),s.jsxs("div",{className:"p-4 border-t border-gray-700 flex gap-2",children:[s.jsx("input",{type:"text",value:J,onChange:e=>ne(e.target.value),onKeyPress:e=>e.key==="Enter"&&ie(),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),s.jsx("button",{onClick:ie,className:"bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700",children:s.jsx(Re,{})})]})]})]}),oe&&s.jsxs("div",{className:"bg-gray-800 px-4 py-3 flex items-center justify-center gap-4",children:[s.jsx("button",{onClick:Ee,className:`p-3 rounded-full ${A?"bg-red-600":"bg-gray-700"} hover:bg-opacity-80 relative`,title:A?"Unmute":"Mute",children:A?s.jsx(Me,{className:"text-xl"}):s.jsx(Oe,{className:"text-xl"})}),s.jsxs("button",{onClick:()=>{se(!b)},className:`p-3 rounded-full ${b?"bg-blue-600":"bg-gray-700"} hover:bg-opacity-80 relative`,title:"Chat",children:[s.jsx(Pe,{className:"text-xl"}),K>0&&!b&&s.jsx("span",{className:"absolute top-0 right-0 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center",children:K>99?"99+":K})]}),s.jsx("button",{onClick:Ne,className:`p-3 rounded-full ${z?"bg-yellow-600":"bg-gray-700"} hover:bg-opacity-80`,title:z?"Lower hand":"Raise hand",children:s.jsx(Ve,{className:"text-xl"})}),s.jsx("button",{onClick:le,className:"p-3 rounded-full bg-red-600 hover:bg-red-700",title:"Leave class",children:s.jsx(De,{className:"text-xl rotate-135"})})]})]})};export{Be as default};
